name: Triage "info-needed" label

on:
  issue_comment:
    types: [created]

env:
  TRIAGERS: '["karrtikr","karthiknadig","paulacamargo25","eleanorjboyd", "brettcannon"]'

jobs:
  add_label:
    runs-on: ubuntu-latest
    env:
      KEYWORDS: '["?", "please", "kindly", "let me know", "try", "inform", "can you", "could you", "would you", "may I", "provide", "tell me", "give me", "send me", "what", "when", "where", "why", "how"]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Check for label and author
        uses: actions/github-script@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = await github.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            const labels = issue.data.labels.map(label => label.name);
            const commentAuthor = context.payload.comment.user.login;
            const commentBody = context.payload.comment.body;
            const isTeamMember = JSON.parse('${{ env.TRIAGERS }}').includes(commentAuthor);

            const keywords = JSON.parse('${{ env.KEYWORDS }}');
            const isRequestForInfo = new RegExp(keywords.join('|'), 'i').test(commentBody);

            const hasInfoNeededLabel = labels.includes('info-needed');
            const hasTriageNeededLabel = labels.includes('triage-needed');
            const isCommentAuthorIssueCreator = commentAuthor !== issue.data.user.login;

            const shouldAddLabel = isTeamMember && !hasInfoNeededLabel && hasTriageNeededLabel && isCommentAuthorIssueCreator && isRequestForInfo;

            console.log(`shouldAddLabel: ${shouldAddLabel}`);

            if (shouldAddLabel) {
              await github.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['info-needed']
              });
            }
